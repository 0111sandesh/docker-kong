version: '3'
services:
    kong-database:
        image: postgres:9.4
        environment:
            - POSTGRES_USER=kong
            - POSTGRES_DB=kong
        healthcheck:
            test: "pg_isready -h localhost -p 5432 -q -U postgres"
            interval: 30s
            timeout: 30s
            retries: 3

    kong-migration:
        image: kong:latest
        depends_on:
            - kong-database
        environment:
            - KONG_DATABASE=postgres
            - KONG_PG_HOST=kong-database 
        command: bash -c "sleep 5; kong migrations up"

    kong:
            image: kong:latest
            restart: always
            depends_on:
                - kong-database
                - kong-migration
            ports:
                - 8000:8000
                - 8443:8443
                - 8001:8001
                - 8444:8444
            environment:
                - KONG_DATABASE=postgres
                - KONG_PG_HOST=kong-database
            healthcheck:
                test: ["CMD-SHELL", "curl -I -s -L http://127.0.0.1:8000 || exit 1"]
                interval: 30s
                timeout: 10s
                retries: 3
            command: bash -c "sleep 10; kong start"
